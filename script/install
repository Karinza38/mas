#!/bin/bash -e
#
# script/install
# mas
#
# Install mas into a bin folder under a prefix folder, defaulting to /usr/local.
#
# NOTE: This script is run by the mas Homebrew formula, so, aside from Swift, it
# may only depend on system dependencies.
#
# https://github.com/Homebrew/homebrew-core/blob/master/Formula/m/mas.rb
#

mas_dir="$(readlink -fn "$(dirname "${BASH_SOURCE:-"${0}"}")/..")"

if ! cd -- "${mas_dir}"; then
  printf $'Error: Could not cd into mas directory: %s\n' "${mas_dir}" >&2
  exit 1
fi

arch="$(uname -m)"
release=".build/${arch}-apple-macosx/release"
prefix=/usr/local

while [[ -n "${1}" ]]; do
  if [[ "${1}" == '--universal' ]]; then
    arch=universal
    release=.build/apple/Products/Release
  else
    prefix="${1}"
  fi

  shift
done

printf $'==> ðŸ“² Installing mas %s for %s to %s\n' \
  "$(script/version)" "${arch}" "${prefix}"

ditto -v "${release}/mas" "${prefix}/bin/mas"
