#!/bin/bash -e
#
# script/package
# mas
#
# Builds macOS installer component and distribution packages.
#

mas_dir="$(readlink -fn "$(dirname "${BASH_SOURCE:-"${0}"}")/..")"

if ! cd -- "${mas_dir}"; then
  printf $'Error: Could not cd into mas directory: %s\n' "${mas_dir}" >&2
  exit 1
fi

build_dir=.build
distribution_package="${build_dir}/mas.pkg"

# Destination for install root
dstroot="${build_dir}/distributions"
script/install "${dstroot}/usr/local" --universal

version="$(script/version)"

printf $'==> ğŸ“¦ Assembling installer package for mas %s\n' "${version}"

# Assemble macOS installer component package (aka 'product archive').
pkgbuild \
  --identifier com.mphys.mas-cli \
  --install-location '/' \
  --version "${version}" \
  --root "${dstroot}" \
  "${build_dir}/mas_components.pkg"

# Build distribution package (aka 'product archive'). Not sure why, but this is how Carthage does it.
# https://github.com/Carthage/Carthage/blob/master/Makefile#L69
productbuild \
  --distribution Package/Distribution.plist \
  --package-path "${build_dir}" \
  "${distribution_package}"

printf $'==> ğŸ”¢ File Hash\n'
shasum -a 256 "${distribution_package}"
