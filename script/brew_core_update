#!/bin/bash -ex
#
# script/brew_core_update
# mas
#
# Updates mas Homebrew core formula:
# https://github.com/Homebrew/homebrew-core/blob/master/Formula/m/mas.rb
#
# brew bump-formula-pr --help
#

mas_dir="$(readlink -fn "$(dirname "${BASH_SOURCE:-"${0}"}")/..")"

if ! cd -- "${mas_dir}"; then
  printf $'Error: Could not cd into mas directory: %s\n' "${mas_dir}" >&2
  exit 1
fi

CORE_TAP_PATH="$(brew --repo homebrew/core)"

function usage {
  echo 'Usage: brew_core_update [-d] [<version_tag> [<sha1_hash>]]' >&2
  echo '  -d option enables dry run mode' >&2
  echo '  version will be inferred using version script if not provided' >&2
  echo '  sha will be inferred from the current commit if not provided' >&2
  exit 1
}

# Max 3 arguments
if [[ "${#}" -gt 3 ]]; then
  usage
fi

dry_run=

# Detect presence of `-d` dry run option
while getopts 'd' o; do
  case "${o}" in
    d)
      dry_run=-d
      ;;
    *)
      usage
      ;;
  esac
done
shift "$((OPTIND - 1))"

# DRY_RUN environment variable
# shellcheck disable=SC2153
if [[ "${DRY_RUN}" == 'true' ]]; then
  dry_run=-d
fi

# arg 1 - version tag
MAS_VERSION="${1:-"v$(script/version)"}"

echo "MAS_VERSION: ${MAS_VERSION}"

# arg 2 - revision (commit hash)
# If arg 2 wasn't supplied or is empty, obtain revision from ${MAS_VERSION} version tag
REVISION="${2:-"$(git rev-parse "${MAS_VERSION}")"}"

echo "REVISION: ${REVISION}"

################################################################################
#
# Preflight checks
#

# Uninstall if necessary
brew remove mas 2>/dev/null || true
brew remove mas-cli/tap/mas 2>/dev/null || true

# Uninstall if still found on path
if command -v mas >/dev/null; then
  script/uninstall || true
fi

# Ensure core is tapped
if ! [[ -d "${CORE_TAP_PATH}" ]]; then
  brew tap homebrew/core
fi

brew update

################################################################################
#
# Build the formula for the current macOS version and architecture.
#

# Update mas formula in core (temporary)
cp -v Homebrew/mas.rb "${CORE_TAP_PATH}/Formula/m/mas.rb"

# Install mas from source
# HOMEBREW_NO_INSTALL_FROM_API:
# Force brew to use the local repository instead of the API.
# Disable API before any install, reinstall or upgrade commands.

HOMEBREW_NO_INSTALL_FROM_API=1 \
  brew install mas \
  --build-from-source \
  --verbose

# Audit formula
brew audit --strict mas
brew style mas

# Revert core formula change after testing
pushd "${CORE_TAP_PATH}"
git diff
git checkout .
popd

################################################################################
#
# Update Homebrew
#

echo "==> ðŸ§ª Updating homebrew-core formula mas (${MAS_VERSION}, ${REVISION})"

echo 'Validating formula'
brew bump-formula-pr \
  --tag="${MAS_VERSION}" \
  --revision="${REVISION}" \
  --strict \
  --verbose \
  --no-browse \
  --fork-org mas-cli \
  --dry-run \
  mas

# brew exit status
status="${?}"
if [[ "${status}" -ne 0 ]]; then
  echo $'Formula did not validate using \'brew bump-formula-pr\'' >&2
  exit "${status}"
fi

if [[ "${dry_run}" == '-d' ]]; then
  exit 0
fi

echo 'Updating homebrew/core formula with a PR'

brew bump-formula-pr \
  --tag="${MAS_VERSION}" \
  --revision="${REVISION}" \
  --strict \
  --verbose \
  --online \
  --no-browse \
  --fork-org mas-cli \
  mas
