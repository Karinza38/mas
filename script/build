#!/bin/zsh -efu
#
# script/build
# mas
#
# Builds the Swift Package.
#

mas_dir="${0:a:h:h}"

if ! cd -- "${mas_dir}"; then
  printf $'Error: Could not cd into mas directory: %s\n' "${mas_dir}" >&2
  exit 1
fi

# Build for the host architecture by default.
if [[ "${#}" -ge 1 && "${1}" == --universal ]]; then
  arch=(
    --arch arm64
    --arch x86_64
  )
else
  arch=()
fi

# Disable the manifest cache.
if [[ "$(swift build --help)" =~ manifest-cache ]]; then
  cache=(--manifest-cache none)
else
  cache=()
fi

script/generate_version_info_for_swift

printf $'==> 🏗️ Building mas %s\n' "$(script/version)"

swift build \
  --configuration release \
  "${arch[@]}" \
  --disable-sandbox \
  "${cache[@]}"
