#!/bin/bash -ex
#
# script/bottle
# mas
#
# Builds bottles of mas Homebrew formula for custom tap:
# https://github.com/mas-cli/homebrew-tap
#
# This script should be run _after_ the formula has been updated in Homebrew
#

################################################################################
#
# Variables
#

mas_dir="$(readlink -fn "$(dirname "${BASH_SOURCE:-"${0}"}")/..")"

if ! cd -- "${mas_dir}"; then
  printf $'Error: Could not cd into mas directory: %s\n' "${mas_dir}" >&2
  exit 1
fi

BOTTLE_DIR=".build/bottles"
CORE_TAP_PATH="$(brew --repo homebrew/core)"
version="$(script/version)"
ROOT_URL="https://github.com/mas-cli/mas/releases/download/v${version}"

# Supports macOS 10.13 and later
OS_NAMES=(
  sequoia
  arm64_sequoia
  sonoma
  arm64_sonoma
  ventura
  arm64_ventura
  monterey
  arm64_monterey
  big_sur
  arm64_big_sur
  catalina
  mojave
  high_sierra
  sierra
  el_capitan
)

macos_version="$(sw_vers -productVersion)"
case "${macos_version%%.*}" in
  15)
    CURRENT_PLATFORM=sequoia
    ;;
  14)
    CURRENT_PLATFORM=sonoma
    ;;
  13)
    CURRENT_PLATFORM=ventura
    ;;
  12)
    CURRENT_PLATFORM=monterey
    ;;
  11)
    CURRENT_PLATFORM=big_sur
    ;;
  10)
    CURRENT_PLATFORM=catalina
    ;;
  *)
    echo 'Unsupported macOS version. This script requires Catalina or newer.' >&2
    exit 1
    ;;
esac

# Prefix platform with architecture
if [[ "$(uname -m)" == 'arm64' ]]; then
  CURRENT_PLATFORM="arm64_${CURRENT_PLATFORM}"
fi

echo "==> 🍼 Bottling mas ${version} on ${CURRENT_PLATFORM} for ${OS_NAMES[*]}"
brew install --build-bottle mas-cli/tap/mas

# Generate bottle do block, dropping last 2 lines
brew bottle --verbose --no-rebuild --root-url="${ROOT_URL}" mas-cli/tap/mas

# Output filename from brew bottle
generated_bottle_filename="mas--${version}.${CURRENT_PLATFORM}.bottle.tar.gz"

if [[ ! -e "${generated_bottle_filename}" ]]; then
  echo "Bottle not found: ${generated_bottle_filename}" >&2
  echo 'If an old version is showing in the log and filename, then make sure the formula has been updated in:' >&2
  echo "${CORE_TAP_PATH}" >&2
  exit 1
fi

mkdir -p "${BOTTLE_DIR}"

for os in "${OS_NAMES[@]}"; do
  cp -v "${generated_bottle_filename}" "${BOTTLE_DIR}/mas-${version}.${os}.bottle.tar.gz"
done

rm "${generated_bottle_filename}"
